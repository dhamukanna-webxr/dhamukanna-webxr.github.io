<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Grab via Sphere Collider (Hand Tracking)</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>
  </head>
  <body>
    <a-scene
      physics="gravity: -9.8"
      webxr="optionalFeatures: hand-tracking"
      vr-mode-ui="enabled: false"
    >

      <!-- Camera -->
      <a-entity camera position="0 1.6 0"></a-entity>

      <!-- Light -->
      <a-entity light="type: ambient; intensity: 1"></a-entity>
      <a-entity light="type: directional; intensity: 0.6" position="1 3 2"></a-entity>

      <!-- Ground -->
      <a-plane static-body rotation="-90 0 0" width="10" height="10" color="#7BC8A4"></a-plane>

      <!-- Grabbable Cube -->
      <a-box id="cube"
             dynamic-body
             color="orange"
             position="0 1.5 -1"
             depth="0.2"
             height="0.2"
             width="0.2"
      ></a-box>

      <!-- Right Hand -->
      <a-entity id="rightHand"
                hand-tracking-controls="hand: right"
                hand-grabber>
        <!-- Fingertip Grab Sphere -->
        <a-sphere id="grabber"
                  radius="0.025"
                  color="red"
                  position="0 0 0"
                  visible="true"></a-sphere>
      </a-entity>

      <script>
        AFRAME.registerComponent('hand-grabber', {
          schema: { threshold: { default: 0.015 } },

          init: function () {
            this.grabbing = false;
            this.grabbedEl = null;
            this.thumbTip = null;
            this.indexTip = null;
            this.grabber = this.el.querySelector('#grabber');
          },

          tick: function () {
            const handObj = this.el.object3D;
            if (!this.thumbTip) {
              this.thumbTip = handObj.getObjectByName('thumb-tip');
              this.indexTip = handObj.getObjectByName('index-finger-tip');
            }

            if (!this.thumbTip || !this.indexTip || !this.grabber) return;

            // Update grab sphere position to follow index finger tip
            const worldPos = new THREE.Vector3();
            this.indexTip.getWorldPosition(worldPos);
            this.grabber.object3D.position.copy(this.el.object3D.worldToLocal(worldPos));

            // Pinch detection
            const pinchDist = this.thumbTip.position.distanceTo(this.indexTip.position);
            const isPinching = pinchDist < this.data.threshold;

            // If pinching and near cube â†’ grab
            const cube = document.querySelector('#cube');
            const cubeObj = cube.object3D;

            const grabberWorld = new THREE.Vector3();
            this.grabber.object3D.getWorldPosition(grabberWorld);

            const cubeWorld = new THREE.Vector3();
            cubeObj.getWorldPosition(cubeWorld);

            const grabDistance = grabberWorld.distanceTo(cubeWorld);

            if (isPinching && !this.grabbing && grabDistance < 0.1) {
              // Grab
              cube.removeAttribute('dynamic-body');
              handObj.attach(cubeObj);
              this.grabbing = true;
              this.grabbedEl = cube;
            }

            if (!isPinching && this.grabbing) {
              // Release
              const scene = this.el.sceneEl;
              scene.object3D.attach(this.grabbedEl.object3D);
              this.grabbedEl.setAttribute('dynamic-body', '');
              this.grabbing = false;
              this.grabbedEl = null;
            }
          }
        });
      </script>

    </a-scene>
  </body>
</html>
